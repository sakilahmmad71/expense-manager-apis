name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-format:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x, 22.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§¹ Run ESLint
        run: npm run lint

      - name: ğŸ’… Check Prettier formatting
        run: npm run format:check

      - name: ğŸ” Run Prisma validation
        run: npx prisma validate

  docker-build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build development Docker image
        run: |
          docker build -f Dockerfile.development -t expense-manager-api:dev .

      - name: ğŸ—ï¸ Build production Docker image
        run: |
          docker build -f Dockerfile.production -t expense-manager-api:prod .

      - name: ğŸ§ª Test Docker containers can start
        run: |
          # Test development image
          docker run --rm -d --name test-dev \
            -e DATABASE_URL="postgresql://test:test@localhost:5432/test" \
            -e JWT_SECRET="test-secret-key-for-ci" \
            expense-manager-api:dev
          sleep 5
          docker logs test-dev
          docker stop test-dev || true

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ›¡ï¸ Run npm audit
        run: npm audit --audit-level moderate

      - name: ğŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  validate-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            fix
            feat
            docs
            style
            refactor
            test
            chore
            ci
          requireScope: false

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [lint-and-format, docker-build, security-scan]
    if: failure()

    steps:
      - name: ğŸ“§ Notify on failure
        run: |
          echo "âŒ CI pipeline failed! Please check the logs above."
          echo "Common issues:"
          echo "- Linting errors: Run 'npm run lint:fix' locally"
          echo "- Formatting issues: Run 'npm run format' locally"  
          echo "- Docker build failures: Test Docker builds locally"
          echo "- Security issues: Check 'npm audit' output"
